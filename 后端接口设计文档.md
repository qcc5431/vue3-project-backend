# 笔记社交平台 - 后端接口设计文档

## 基础信息

- **Base URL**: `http://localhost`
- **认证方式**: Bearer Token (JWT)
- **请求格式**: JSON
- **响应格式**: JSON

## 通用响应格式

```json
{
  "code": 200,
  "message": "success",
  "data": {}
}
```

**状态码说明**：

- `200` - 成功
- `400` - 请求参数错误
- `401` - 未登录/Token失效
- `403` - 无权限
- `404` - 资源不存在
- `500` - 服务器错误

---

## 一、用户模块 `/api/users`

### 1.1 用户注册

**POST** `/api/users/register`

**请求参数**：

```json
{
  "username": "string", // 用户名，必填
  "password": "string", // 密码，必填
  "email": "string" // 邮箱，必填
}
```

**响应示例**：

```json
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "id": 1,
    "username": "旅行者小王",
    "email": "test@example.com",
    "avatar": "https://api.dicebear.com/7.x/avataaars/svg?seed=xxx"
  }
}
```

---

### 1.2 用户登录

**POST** `/api/users/login`

**请求参数**：

```json
{
  "account": "string", // 用户名或邮箱
  "password": "string" // 密码
}
```

**响应示例**：

```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": 1,
      "username": "旅行者小王",
      "email": "test@example.com",
      "avatar": "https://api.dicebear.com/7.x/avataaars/svg?seed=xxx"
    }
  }
}
```

---

### 1.3 获取当前用户信息

**GET** `/api/users/info`

**请求头**：

```
Authorization: Bearer <token>
```

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "username": "旅行者小王",
    "email": "test@example.com",
    "avatar": "https://api.dicebear.com/7.x/avataaars/svg?seed=xxx"
  }
}
```

---

### 1.4 获取用户详情

**GET** `/api/users/:id`

**路径参数**：

- `id` - 用户ID

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "2",
    "username": "traveler02",
    "nickname": "旅行达人",
    "avatar": "https://api.dicebear.com/7.x/avataaars/svg?seed=xxx",
    "bio": "热爱旅行和摄影",
    "followingCount": 56,
    "followersCount": 1280,
    "likeCount": 5200,
    "isFollowing": false
  }
}
```

---

## 二、笔记模块 `/api/notes`

### 2.1 获取笔记列表

**GET** `/api/notes`

**查询参数**：
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| page | number | 否 | 页码，默认1 |
| pageSize | number | 否 | 每页数量，默认20 |
| sortType | string | 否 | 排序方式：`latest`(最新)、`hot`(热门)、`recommend`(推荐，默认) |
| authorId | string | 否 | 指定作者ID，获取某用户的笔记 |
| isFollowing | boolean | 否 | 是否只看关注的用户 |
| isCollected | boolean | 否 | 是否只看收藏的笔记 |

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": "1",
        "title": "探索云南秘境",
        "content": "# 云南旅行...",
        "coverMedia": [
          {
            "type": "image",
            "url": "https://picsum.photos/800/600",
            "width": 800,
            "height": 600
          }
        ],
        "images": ["https://picsum.photos/800/600"],
        "authorId": "2",
        "authorName": "旅行达人",
        "authorAvatar": "https://api.dicebear.com/7.x/avataaars/svg?seed=xxx",
        "visibility": "public",
        "likeCount": 128,
        "collectCount": 45,
        "commentCount": 23,
        "viewCount": 1024,
        "isLiked": false,
        "isCollected": false,
        "createdAt": "2026-02-20T10:30:00Z",
        "updatedAt": "2026-02-20T10:30:00Z"
      }
    ],
    "total": 100,
    "page": 1,
    "pageSize": 20
  }
}
```

**重要说明**：

- 列表接口 `coverMedia` 只返回第一张封面（减少数据传输）
- 详情接口返回完整 `coverMedia`

---

### 2.2 获取笔记详情

**GET** `/api/notes/:id`

**路径参数**：

- `id` - 笔记ID

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "1",
    "title": "探索云南秘境",
    "content": "# 云南旅行\n\n这是一次难忘的旅程...",
    "coverMedia": [
      {
        "type": "image",
        "url": "https://picsum.photos/800/600",
        "width": 800,
        "height": 600
      },
      {
        "type": "image",
        "url": "https://picsum.photos/800/600",
        "width": 800,
        "height": 600
      }
    ],
    "images": ["https://picsum.photos/800/600", "https://picsum.photos/800/600"],
    "authorId": "2",
    "authorName": "旅行达人",
    "authorAvatar": "https://api.dicebear.com/7.x/avataaars/svg?seed=xxx",
    "visibility": "public",
    "likeCount": 128,
    "collectCount": 45,
    "commentCount": 23,
    "viewCount": 1024,
    "isLiked": false,
    "isCollected": false,
    "createdAt": "2026-02-20T10:30:00Z",
    "updatedAt": "2026-02-20T10:30:00Z"
  }
}
```

---

### 2.3 创建笔记

**POST** `/api/notes`

**请求头**：

```
Authorization: Bearer <token>
```

**请求参数**：

```json
{
  "title": "string", // 标题，必填
  "content": "string", // Markdown内容，必填
  "coverMedia": [
    // 封面媒体数组（图片/视频已上传至COS）
    {
      "type": "image",
      "url": "https://web-front-1360774249.cos.ap-beijing.myqcloud.com/uploads/images/notes/xxx.jpg",
      "width": 800,
      "height": 600
    }
  ],
  "images": [
    // 文中图片URL列表（已上传至COS）
    "https://web-front-1360774249.cos.ap-beijing.myqcloud.com/uploads/images/notes/xxx.jpg"
  ],
  "visibility": "public" // 可见性：public/private
}
```

**图片上传流程**：

1. 用户选择图片时，前端立即上传到腾讯云COS
2. 上传成功后返回真实URL，用于预览和提交
3. 后端需定期清理未被引用的图片（用户选了又删除的）

**响应示例**：

```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": "123"
  }
}
```

---

### 2.4 更新笔记

**PUT** `/api/notes/:id`

**请求头**：

```
Authorization: Bearer <token>
```

**路径参数**：

- `id` - 笔记ID

**请求参数**：

```json
{
  "title": "string",
  "content": "string",
  "coverMedia": [
    {
      "type": "image",
      "url": "https://web-front-1360774249.cos.ap-beijing.myqcloud.com/uploads/images/notes/xxx.jpg",
      "width": 800,
      "height": 600
    }
  ],
  "images": [
    "https://web-front-1360774249.cos.ap-beijing.myqcloud.com/uploads/images/notes/xxx.jpg"
  ],
  "visibility": "public"
}
```

**响应示例**：

```json
{
  "code": 200,
  "message": "更新成功"
}
```

---

### 2.5 删除笔记

**DELETE** `/api/notes/:id`

**请求头**：

```
Authorization: Bearer <token>
```

**路径参数**：

- `id` - 笔记ID

**响应示例**：

```json
{
  "code": 200,
  "message": "删除成功"
}
```

---

### 2.6 点赞笔记

**POST** `/api/notes/:id/like`

**请求头**：

```
Authorization: Bearer <token>
```

**路径参数**：

- `id` - 笔记ID

**响应示例**：

```json
{
  "code": 200,
  "message": "点赞成功",
  "data": {
    "isLiked": true,
    "likeCount": 129
  }
}
```

**说明**：再次调用取消点赞

---

### 2.7 收藏笔记

**POST** `/api/notes/:id/collect`

**请求头**：

```
Authorization: Bearer <token>
```

**路径参数**：

- `id` - 笔记ID

**响应示例**：

```json
{
  "code": 200,
  "message": "收藏成功",
  "data": {
    "isCollected": true,
    "collectCount": 46
  }
}
```

**说明**：再次调用取消收藏

---

## 三、社交模块 `/api/social`

### 3.1 关注用户

**POST** `/api/social/follow`

**请求头**：

```
Authorization: Bearer <token>
```

**请求参数**：

```json
{
  "userId": "string" // 要关注的用户ID
}
```

**响应示例**：

```json
{
  "code": 200,
  "message": "关注成功",
  "data": {
    "isFollowing": true
  }
}
```

**说明**：再次调用取消关注

---

### 3.2 获取关注列表

**GET** `/api/social/following`

**请求头**：

```
Authorization: Bearer <token>
```

**查询参数**：
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| userId | string | 否 | 用户ID，不传则获取当前用户的 |
| page | number | 否 | 页码，默认1 |
| pageSize | number | 否 | 每页数量，默认10 |

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": "2",
        "username": "traveler02",
        "nickname": "旅行达人",
        "avatar": "https://api.dicebear.com/7.x/avataaars/svg?seed=xxx",
        "bio": "热爱旅行和摄影",
        "followingCount": 56,
        "followersCount": 1280,
        "likeCount": 5200,
        "isFollowing": true
      }
    ],
    "total": 15,
    "page": 1,
    "pageSize": 10
  }
}
```

---

### 3.3 获取粉丝列表

**GET** `/api/social/followers`

**请求头**：

```
Authorization: Bearer <token>
```

**查询参数**：
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| userId | string | 否 | 用户ID，不传则获取当前用户的 |
| page | number | 否 | 页码，默认1 |
| pageSize | number | 否 | 每页数量，默认10 |

**响应示例**：同关注列表

---

### 3.4 获取评论列表

**GET** `/api/social/comments`

**查询参数**：
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| noteId | string | 是 | 笔记ID |
| page | number | 否 | 页码，默认1 |
| pageSize | number | 否 | 每页数量，默认10 |

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": "c1",
        "noteId": "1",
        "userId": "3",
        "username": "小明",
        "userAvatar": "https://api.dicebear.com/7.x/avataaars/svg?seed=xxx",
        "content": "太棒了！",
        "likeCount": 5,
        "isLiked": false,
        "replyTo": null,
        "replyToUser": null,
        "createdAt": "2026-02-20T12:00:00Z"
      }
    ],
    "total": 23,
    "page": 1,
    "pageSize": 10
  }
}
```

---

### 3.5 发表评论

**POST** `/api/social/comments`

**请求头**：

```
Authorization: Bearer <token>
```

**请求参数**：

```json
{
  "noteId": "string", // 笔记ID，必填
  "content": "string", // 评论内容，必填
  "replyTo": "string" // 回复的评论ID，可选
}
```

**响应示例**：

```json
{
  "code": 200,
  "message": "评论成功",
  "data": {
    "id": "c123"
  }
}
```

---

## 四、文件夹模块 `/api/folders`

### 4.1 获取文件夹列表

**GET** `/api/folders`

**请求头**：

```
Authorization: Bearer <token>
```

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": "folder-1",
      "name": "旅行攻略",
      "noteCount": 12,
      "createdAt": "2026-01-15T08:00:00Z",
      "updatedAt": "2026-02-20T10:30:00Z"
    }
  ]
}
```

---

### 4.2 创建文件夹

**POST** `/api/folders`

**请求头**：

```
Authorization: Bearer <token>
```

**请求参数**：

```json
{
  "name": "string" // 文件夹名称，必填
}
```

**响应示例**：

```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": "folder-123",
    "name": "新建文件夹",
    "noteCount": 0,
    "createdAt": "2026-02-26T10:00:00Z",
    "updatedAt": "2026-02-26T10:00:00Z"
  }
}
```

---

### 4.3 更新文件夹

**PUT** `/api/folders/:id`

**请求头**：

```
Authorization: Bearer <token>
```

**路径参数**：

- `id` - 文件夹ID

**请求参数**：

```json
{
  "name": "string" // 新名称
}
```

**响应示例**：

```json
{
  "code": 200,
  "message": "更新成功"
}
```

---

### 4.4 删除文件夹

**DELETE** `/api/folders/:id`

**请求头**：

```
Authorization: Bearer <token>
```

**路径参数**：

- `id` - 文件夹ID

**响应示例**：

```json
{
  "code": 200,
  "message": "删除成功"
}
```

---

### 4.5 添加笔记到文件夹

**POST** `/api/folders/:folderId/notes/:noteId`

**请求头**：

```
Authorization: Bearer <token>
```

**路径参数**：

- `folderId` - 文件夹ID
- `noteId` - 笔记ID

**响应示例**：

```json
{
  "code": 200,
  "message": "添加成功"
}
```

---

### 4.6 从文件夹移除笔记

**DELETE** `/api/folders/:folderId/notes/:noteId`

**请求头**：

```
Authorization: Bearer <token>
```

**路径参数**：

- `folderId` - 文件夹ID
- `noteId` - 笔记ID

**响应示例**：

```json
{
  "code": 200,
  "message": "移除成功"
}
```

---

## 五、文件上传模块 `/api/upload`

### 存储方案：腾讯云COS

**配置信息**：

- 存储类型：腾讯云对象存储（COS）
- 存储桶（Bucket）：`web-front-1360774249`
- 地域（Region）：`ap-beijing`（根据实际配置）
- 访问域名：`https://web-front-1360774249.cos.ap-beijing.myqcloud.com`

**后端环境变量配置**：

```env
# 腾讯云COS配置
COS_SECRET_ID=your_secret_id
COS_SECRET_KEY=your_secret_key
COS_BUCKET=your-bucket-name
COS_REGION=ap-guangzhou
```

**文件路径规范**：

```
/uploads/
  ├── images/           # 图片目录
  │   ├── notes/        # 笔记图片
  │   └── avatars/      # 用户头像
  └── videos/           # 视频目录
      └── notes/        # 笔记视频
```

**文件命名规则**：

- 格式：`{类型}/{年月}/{日时分秒}_{随机字符串}.{扩展名}`
- 示例：`images/notes/202602/26103045_abc123.jpg`

---

### 5.1 上传图片

**POST** `/api/upload/image`

**请求头**：

```
Authorization: Bearer <token>
Content-Type: multipart/form-data
```

**请求参数**：

- `file` - 图片文件（支持 jpg、png、gif、webp）
- `type` - 图片类型（可选）：`note`（笔记图片，默认）、`avatar`（头像）

**响应示例**：

```json
{
  "code": 200,
  "message": "上传成功",
  "data": {
    "url": "https://your-bucket.cos.ap-guangzhou.myqcloud.com/uploads/images/notes/202602/26103045_abc123.jpg",
    "width": 800,
    "height": 600
  }
}
```

**后端处理逻辑**：

1. 接收文件，验证格式和大小（限制10MB）
2. 使用 `sharp` 库读取图片宽高
3. 上传到腾讯云COS
4. 返回完整URL和尺寸信息

---

### 5.2 上传视频

**POST** `/api/upload/video`

**请求头**：

```
Authorization: Bearer <token>
Content-Type: multipart/form-data
```

**请求参数**：

- `file` - 视频文件（支持 mp4、mov、avi、webm）

**响应示例**：

```json
{
  "code": 200,
  "message": "上传成功",
  "data": {
    "url": "https://your-bucket.cos.ap-guangzhou.myqcloud.com/uploads/videos/notes/202602/26103045_xyz789.mp4",
    "width": 1920,
    "height": 1080,
    "duration": 120
  }
}
```

**后端处理逻辑**：

1. 接收文件，验证格式和大小（限制500MB）
2. 使用 `fluent-ffmpeg` 读取视频元数据（宽高、时长）
3. 上传到腾讯云COS
4. 返回完整URL和元数据信息

---

### 5.3 获取上传凭证（可选，前端直传方案）

**GET** `/api/upload/credential`

**说明**：如果采用前端直传COS方案，后端提供临时密钥

**请求头**：

```
Authorization: Bearer <token>
```

**查询参数**：
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| type | string | 是 | 文件类型：`image` / `video` |
| ext | string | 是 | 文件扩展名：`jpg` / `mp4` 等 |

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "uploadUrl": "https://your-bucket.cos.ap-guangzhou.myqcloud.com",
    "key": "uploads/images/notes/202602/26103045_abc123.jpg",
    "credentials": {
      "tmpSecretId": "AKIDxxxx",
      "tmpSecretKey": "xxxx",
      "sessionToken": "xxxx",
      "expiredTime": 1708934400
    }
  }
}
```

---

## 六、数据类型定义

### MediaItem 媒体项

```typescript
interface MediaItem {
  type: 'image' | 'video' // 类型
  url: string // URL地址
  width: number // 宽度
  height: number // 高度
  duration?: number // 视频时长（秒），仅视频有
}
```

### Note 笔记

```typescript
interface Note {
  id: string
  title: string
  content: string // Markdown格式
  coverMedia: MediaItem[] // 封面媒体
  images: string[] // 文中图片URL列表
  authorId: string
  authorName: string
  authorAvatar: string
  visibility: 'public' | 'private'
  likeCount: number
  collectCount: number
  commentCount: number
  viewCount: number
  isLiked?: boolean // 当前用户是否点赞
  isCollected?: boolean // 当前用户是否收藏
  createdAt: string // ISO 8601格式
  updatedAt: string
}
```

### UserBrief 用户简要信息

```typescript
interface UserBrief {
  id: string
  username: string
  nickname: string
  avatar: string
  bio?: string
  followingCount: number // 关注数
  followersCount: number // 粉丝数
  likeCount: number // 获赞数
  isFollowing?: boolean // 当前用户是否关注
}
```

### Comment 评论

```typescript
interface Comment {
  id: string
  noteId: string
  userId: string
  username: string
  userAvatar: string
  content: string
  likeCount: number
  isLiked?: boolean
  replyTo?: string // 回复的评论ID
  replyToUser?: string // 回复的用户名
  createdAt: string
}
```

### Folder 文件夹

```typescript
interface Folder {
  id: string
  name: string
  noteCount: number
  createdAt: string
  updatedAt: string
}
```

---

## 七、重要说明

### 7.1 列表接口优化

- **笔记列表**：`coverMedia` 只返回第一张封面
- **笔记详情**：`coverMedia` 返回完整数组

### 7.2 图片尺寸约定

- 图片宽高信息由后端在接口数据中直接返回
- 前端不进行任何推算或计算

### 7.3 认证机制

- 登录成功返回 JWT Token
- 需要认证的接口在请求头携带：`Authorization: Bearer <token>`
- Token 过期返回 401 状态码

### 7.4 分页规范

- 页码从 1 开始
- 默认每页 20 条
- 响应包含 `total`、`page`、`pageSize`

---

## 八、接口汇总表

| 模块   | 方法   | 路径                                 | 说明             | 认证 |
| ------ | ------ | ------------------------------------ | ---------------- | ---- |
| 用户   | POST   | /api/users/register                  | 注册             | ❌   |
| 用户   | POST   | /api/users/login                     | 登录             | ❌   |
| 用户   | GET    | /api/users/info                      | 获取当前用户信息 | ✅   |
| 用户   | GET    | /api/users/:id                       | 获取用户详情     | ❌   |
| 笔记   | GET    | /api/notes                           | 获取笔记列表     | ❌   |
| 笔记   | GET    | /api/notes/:id                       | 获取笔记详情     | ❌   |
| 笔记   | POST   | /api/notes                           | 创建笔记         | ✅   |
| 笔记   | PUT    | /api/notes/:id                       | 更新笔记         | ✅   |
| 笔记   | DELETE | /api/notes/:id                       | 删除笔记         | ✅   |
| 笔记   | POST   | /api/notes/:id/like                  | 点赞/取消点赞    | ✅   |
| 笔记   | POST   | /api/notes/:id/collect               | 收藏/取消收藏    | ✅   |
| 社交   | POST   | /api/social/follow                   | 关注/取消关注    | ✅   |
| 社交   | GET    | /api/social/following                | 获取关注列表     | ✅   |
| 社交   | GET    | /api/social/followers                | 获取粉丝列表     | ✅   |
| 社交   | GET    | /api/social/comments                 | 获取评论列表     | ❌   |
| 社交   | POST   | /api/social/comments                 | 发表评论         | ✅   |
| 文件夹 | GET    | /api/folders                         | 获取文件夹列表   | ✅   |
| 文件夹 | POST   | /api/folders                         | 创建文件夹       | ✅   |
| 文件夹 | PUT    | /api/folders/:id                     | 更新文件夹       | ✅   |
| 文件夹 | DELETE | /api/folders/:id                     | 删除文件夹       | ✅   |
| 文件夹 | POST   | /api/folders/:folderId/notes/:noteId | 添加笔记到文件夹 | ✅   |
| 文件夹 | DELETE | /api/folders/:folderId/notes/:noteId | 从文件夹移除笔记 | ✅   |
| 上传   | POST   | /api/upload/image                    | 上传图片         | ✅   |
| 上传   | POST   | /api/upload/video                    | 上传视频         | ✅   |
| 上传   | GET    | /api/upload/credential               | 获取上传凭证     | ✅   |

---

**文档版本**: v1.2  
**最后更新**: 2026-02-26
